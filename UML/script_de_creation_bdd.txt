CREATE TYPE enum_role AS ENUM ('visiteur', 'simple', 'complexe', 'admin');
CREATE TYPE enum_statut AS ENUM ('actif', 'inactif', 'maintenance');
CREATE TYPE enum_type_outil AS ENUM ('capteur', 'thermostat', 'gestion_transport', 'signalement_incident', 'gestion_acces');
CREATE TYPE enum_type_donnee AS ENUM ('temperature', 'humidite', 'stock');
CREATE TYPE enum_niveau AS ENUM ('debutant', 'intermediaire', 'avance', 'expert');
CREATE TYPE enum_incident_statut AS ENUM ('ouvert', 'ferm√©', 'en cours');

CREATE TABLE IF NOT EXISTS "Utilisateur" (
    id SERIAL PRIMARY KEY,
    nom_utilisateur VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    mot_de_passe TEXT NOT NULL,
    role enum_role DEFAULT 'simple',
    age INTEGER,
    genre VARCHAR(20),
    date_naissance DATE,
    type_membre VARCHAR(50),
    photo_profil VARCHAR(255),
    date_creation TIMESTAMP DEFAULT NOW(),
    nom VARCHAR(100),
    prenom VARCHAR(100),
    niveau enum_niveau DEFAULT 'debutant',
    points_experience FLOAT DEFAULT 0,
    is_private_email BOOLEAN DEFAULT TRUE,
    is_private_name BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS "Piece" (
    id SERIAL PRIMARY KEY,
    nom VARCHAR(100),
    description TEXT
);

CREATE TABLE IF NOT EXISTS "ObjetConnecte" (
    id SERIAL PRIMARY KEY,
    nom VARCHAR(100),
    description TEXT,
    categorie VARCHAR(50),
    statut enum_statut DEFAULT 'actif',
    emplacement VARCHAR(100),
    date_ajout TIMESTAMP DEFAULT NOW(),
    derniere_mise_a_jour TIMESTAMP DEFAULT NOW(),
    marque VARCHAR(50),
    type VARCHAR(50),
    connectivite VARCHAR(50),
    etat_batterie INTEGER,
    piece_id INTEGER REFERENCES "Piece"(id),
    type_outil enum_type_outil,
    description_outil TEXT,
    capacite INTEGER,
    consommation_energie FLOAT,
    niveau_de_bruit INTEGER,
    utilisateur_id INTEGER REFERENCES "Utilisateur"(id)
);

CREATE TABLE IF NOT EXISTS "DonneeObjet" (
    id SERIAL PRIMARY KEY,
    objet_id INTEGER REFERENCES "ObjetConnecte"(id),
    type_donnee enum_type_donnee,
    valeur TEXT,
    date_relevee TIMESTAMP DEFAULT NOW(),
    unite_mesure VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS "Incident" (
    id SERIAL PRIMARY KEY,
    objet_id INTEGER REFERENCES "ObjetConnecte"(id),
    utilisateur_id INTEGER REFERENCES "Utilisateur"(id),
    date_incident TIMESTAMP DEFAULT NOW(),
    description TEXT,
    statut enum_incident_statut DEFAULT 'ouvert'
);

CREATE TABLE IF NOT EXISTS "ActiviteUtilisateur" (
    id SERIAL PRIMARY KEY,
    utilisateur_id INTEGER REFERENCES "Utilisateur"(id),
    type_activite VARCHAR(50),
    date_activite TIMESTAMP DEFAULT NOW(),
    details TEXT,
    points_gagnes FLOAT DEFAULT 0,
    adresse_ip VARCHAR(45),
    objet_id INTEGER,
    ancien_etat TEXT,
    nouvel_etat TEXT
);
